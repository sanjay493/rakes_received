{% extends "base.html" %}
{% block content %}

<div class="card" style="background: linear-gradient(135deg, #1e88e5 0%, #1565c0 100%); color: white;">
    <h2 style="color: white; margin-bottom: 10px;">üìä Commodity-Wise Transit Time Analysis</h2>
    <p style="color: rgba(255,255,255,0.9); margin: 0;">Comprehensive view of transit performance across all source stations, grouped by commodity and destination</p>
</div>

<!-- Filters -->
<div class="card">
    <h3>Filters</h3>
    <form method="GET" action="/commodity_analysis" id="filterForm">
        <div class="filter-grid" style="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));">
            <div>
                <label>Commodity</label>
                <select name="commodity" onchange="this.form.submit()">
                    <option value="">All Commodities</option>
                    {% for c in commodities %}
                    <option value="{{ c }}" {% if c == selected_commodity %}selected{% endif %}>{{ c }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label>Destination Plant</label>
                <select name="destination" onchange="this.form.submit()">
                    <option value="">All Destinations</option>
                    {% for d in destinations %}
                    <option value="{{ d }}" {% if d == selected_destination %}selected{% endif %}>{{ d }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
    </form>
</div>

<!-- Analysis Tables -->
{% if grouped_data %}
    {% for (commodity, destination), sources in grouped_data.items() %}
    <div class="card" style="margin-top: 20px;">
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
            <h3 style="color: white; margin: 0; display: flex; align-items: center; gap: 10px;">
                <span style="font-size: 1.3em;">üì¶</span>
                <span>{{ commodity }}</span>
                <span style="font-size: 0.9em; opacity: 0.9;">‚Üí</span>
                <span style="background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 6px;">{{ destination }}</span>
            </h3>
        </div>

        <div style="overflow-x: auto;">
            <table style="width: 100%; table-layout: fixed; border-collapse: collapse; font-size: 13px;">
                <colgroup>
                    <!-- Source Station: 8% -->
                    <col style="width: 8%;">
                    <!-- Last 4 Months: 32% (8% each) -->
                    <col style="width: 8%;">
                    <col style="width: 8%;">
                    <col style="width: 8%;">
                    <col style="width: 8%;">
                    <!-- Last 4 Weeks: 32% (8% each) -->
                    <col style="width: 8%;">
                    <col style="width: 8%;">
                    <col style="width: 8%;">
                    <col style="width: 8%;">
                    <!-- Last 4 Days: 32% (8% each) -->
                    <col style="width: 8%;">
                    <col style="width: 8%;">
                    <col style="width: 8%;">
                    <col style="width: 8%;">
                    <!-- Best Monthly: 6% -->
                    <col style="width: 6%;">
                    <!-- Best Fortnightly: 6% -->
                    <col style="width: 6%;">
                    <!-- Best Weekly: 6% -->
                    <col style="width: 6%;">
                    <!-- Outliers: 6% -->
                    <col style="width: 6%;">
                </colgroup>
                <thead>
                    <tr style="background: linear-gradient(to bottom, #f8f9fa 0%, #e9ecef 100%); border-bottom: 2px solid #dee2e6;">
                        <th rowspan="2" style="padding: 8px 4px; text-align: left; font-weight: bold; color: #1f3a5f; border-right: 1px solid #dee2e6; position: sticky; left: 0; background: #f8f9fa; z-index: 10; font-size: 11px; word-wrap: break-word; overflow-wrap: break-word;">
                            Source Station
                        </th>
                        <th colspan="4" style="padding: 10px 4px; text-align: center; font-weight: bold; color: #0277bd; border-right: 1px solid #dee2e6; background: #e3f2fd; font-size: 12px;">
                            Last 4 Months
                        </th>
                        <th colspan="4" style="padding: 10px 4px; text-align: center; font-weight: bold; color: #00796b; border-right: 1px solid #dee2e6; background: #e0f2f1; font-size: 12px;">
                            Last 4 Weeks
                        </th>
                        <th colspan="4" style="padding: 10px 4px; text-align: center; font-weight: bold; color: #f57c00; border-right: 1px solid #dee2e6; background: #fff3e0; font-size: 12px;">
                            Last 4 Days
                        </th>
                        <th rowspan="2" style="padding: 8px 2px; text-align: center; font-weight: bold; color: #7b1fa2; border-right: 1px solid #dee2e6; background: #f3e5f5; font-size: 10px; word-wrap: break-word; overflow-wrap: break-word; line-height: 1.2;">
                            Best Monthly*
                        </th>
                        <th rowspan="2" style="padding: 8px 2px; text-align: center; font-weight: bold; color: #c62828; border-right: 1px solid #dee2e6; background: #ffebee; font-size: 10px; word-wrap: break-word; overflow-wrap: break-word; line-height: 1.2;">
                            Best Fortnightly*
                        </th>
                        <th rowspan="2" style="padding: 8px 2px; text-align: center; font-weight: bold; color: #2e7d32; border-right: 1px solid #dee2e6; background: #e8f5e9; font-size: 10px; word-wrap: break-word; overflow-wrap: break-word; line-height: 1.2;">
                            Best Weekly*
                        </th>
                        <th rowspan="2" style="padding: 8px 4px; text-align: center; font-weight: bold; color: #d84315; border-left: 2px solid #dee2e6; background: #fbe9e7; font-size: 11px;">
                            Outliers
                        </th>
                    </tr>
                    <tr style="background: linear-gradient(to bottom, #f8f9fa 0%, #e9ecef 100%); border-bottom: 2px solid #495057;">
                        <!-- Last 4 Months - Actual month labels -->
                        {% for month_label in header_months %}
                        <th style="padding: 6px 2px; text-align: center; font-size: 9px; color: #01579b; background: #e3f2fd; font-weight: bold; {% if loop.index == 4 %}border-right: 1px solid #dee2e6;{% endif %} word-wrap: break-word; overflow-wrap: break-word;">
                            {{ month_label }}
                        </th>
                        {% endfor %}
                        
                        <!-- Last 4 Weeks - Actual week date ranges -->
                        {% for week_label in header_weeks %}
                        <th style="padding: 6px 2px; text-align: center; font-size: 9px; color: #004d40; background: #e0f2f1; font-weight: bold; {% if loop.index == 4 %}border-right: 1px solid #dee2e6;{% endif %} word-wrap: break-word; overflow-wrap: break-word;">
                            {{ week_label }}
                        </th>
                        {% endfor %}
                        
                        <!-- Last 4 Days - Actual day dates -->
                        {% for day_label in header_days %}
                        <th style="padding: 6px 2px; text-align: center; font-size: 9px; color: #e65100; background: #fff3e0; font-weight: bold; {% if loop.index == 4 %}border-right: 1px solid #dee2e6;{% endif %} word-wrap: break-word; overflow-wrap: break-word;">
                            {{ day_label }}
                        </th>
                        {% endfor %}
                        
                        <!-- Best columns removed since they are rowspan=2 in first row -->
                    </tr>
                </thead>
                <tbody>
                    {% for item in sources %}
                    <tr style="border-bottom: 1px solid #e9ecef; {% if loop.index % 2 == 0 %}background: #f8f9fa;{% else %}background: white;{% endif %} transition: all 0.2s;" 
                        onmouseover="this.style.background='#e3f2fd'" 
                        onmouseout="this.style.background='{% if loop.index % 2 == 0 %}#f8f9fa{% else %}white{% endif %}'">
                        
                        <!-- Source Station -->
                        <td style="padding: 10px 4px; font-weight: 700; color: #1f3a5f; border-right: 1px solid #dee2e6; position: sticky; left: 0; background: inherit; z-index: 5; font-size: 11px; word-wrap: break-word; overflow-wrap: break-word;">
                            {{ item.source }}
                        </td>
                        
                        <!-- Last 4 Months - Individual month columns -->
                        {% for month in item.months_data[:4] %}
                        <td style="padding: 8px 4px; text-align: center; background: rgba(227, 242, 253, 0.3); {% if loop.index == 4 %}border-right: 1px solid #dee2e6;{% endif %}">
                            {% if month.avg %}
                            <div style="font-weight: 700; color: #0277bd; font-size: 13px; margin-bottom: 4px;">
                                {{ month.avg }}
                            </div>
                            <div style="display: inline-block; background: #1976d2; color: white; border-radius: 50%; width: 28px; height: 28px; line-height: 28px; font-weight: bold; font-size: 10px;">
                                {{ month.count }}
                            </div>
                            {% else %}
                            <div style="color: #999; font-size: 13px;">‚Äî</div>
                            {% endif %}
                        </td>
                        {% endfor %}
                        <!-- Fill empty month slots if less than 4 -->
                        {% for i in range(4 - item.months_data|length) %}
                        <td style="padding: 8px 4px; text-align: center; background: rgba(227, 242, 253, 0.3); {% if loop.index == (4 - item.months_data|length) %}border-right: 1px solid #dee2e6;{% endif %}">
                            <div style="color: #999; font-size: 11px;">‚Äî</div>
                        </td>
                        {% endfor %}
                        
                        <!-- Last 4 Weeks - Individual week columns -->
                        {% for week in item.weeks_data[:4] %}
                        <td style="padding: 8px 4px; text-align: center; background: rgba(224, 242, 241, 0.3); {% if loop.index == 4 %}border-right: 1px solid #dee2e6;{% endif %}">
                            {% if week.avg %}
                            <div style="font-weight: 700; color: #00796b; font-size: 13px; margin-bottom: 4px;">
                                {{ week.avg }}
                            </div>
                            <div style="display: inline-block; background: #00897b; color: white; border-radius: 50%; width: 28px; height: 28px; line-height: 28px; font-weight: bold; font-size: 10px;">
                                {{ week.count }}
                            </div>
                            {% else %}
                            <div style="color: #999; font-size: 13px;">‚Äî</div>
                            {% endif %}
                        </td>
                        {% endfor %}
                        <!-- Fill empty week slots if less than 4 -->
                        {% for i in range(4 - item.weeks_data|length) %}
                        <td style="padding: 8px 4px; text-align: center; background: rgba(224, 242, 241, 0.3); {% if loop.index == (4 - item.weeks_data|length) %}border-right: 1px solid #dee2e6;{% endif %}">
                            <div style="color: #999; font-size: 11px;">‚Äî</div>
                        </td>
                        {% endfor %}
                        
                        <!-- Last 4 Days - Individual day columns -->
                        {% for day in item.days_data[:4] %}
                        <td style="padding: 8px 4px; text-align: center; background: rgba(255, 243, 224, 0.3); {% if loop.index == 4 %}border-right: 1px solid #dee2e6;{% endif %}">
                            {% if day.avg %}
                            <div style="font-weight: 700; color: #f57c00; font-size: 13px; margin-bottom: 4px;">
                                {{ day.avg }}
                            </div>
                            <div style="display: inline-block; background: #f57c00; color: white; border-radius: 50%; width: 28px; height: 28px; line-height: 28px; font-weight: bold; font-size: 10px;">
                                {{ day.count }}
                            </div>
                            {% else %}
                            <div style="color: #999; font-size: 13px;">‚Äî</div>
                            {% endif %}
                        </td>
                        {% endfor %}
                        <!-- Fill empty day slots if less than 4 -->
                        {% for i in range(4 - item.days_data|length) %}
                        <td style="padding: 8px 4px; text-align: center; background: rgba(255, 243, 224, 0.3); {% if loop.index == (4 - item.days_data|length) %}border-right: 1px solid #dee2e6;{% endif %}">
                            <div style="color: #999; font-size: 11px;">‚Äî</div>
                        </td>
                        {% endfor %}
                        
                        <!-- Best Monthly -->
                        <td style="padding: 10px 4px; text-align: center; background: rgba(243, 229, 245, 0.4); border-right: 1px solid #dee2e6;">
                            <div style="font-weight: 700; color: #7b1fa2; font-size: 13px; margin-bottom: 4px;">
                                {{ item.best_monthly if item.best_monthly else '‚Äî' }}
                            </div>
                            <div style="display: inline-block; background: #7b1fa2; color: white; border-radius: 50%; width: 32px; height: 32px; line-height: 32px; font-weight: bold; font-size: 11px; cursor: help;" 
                                 title="Rake count in the best performing month">
                                {{ item.best_monthly_count if item.best_monthly_count else 0 }}
                            </div>
                        </td>
                        
                        <!-- Best Fortnightly -->
                        <td style="padding: 10px 4px; text-align: center; background: rgba(255, 235, 238, 0.4); border-right: 1px solid #dee2e6;">
                            <div style="font-weight: 700; color: #c62828; font-size: 13px; margin-bottom: 4px;">
                                {{ item.best_fortnightly if item.best_fortnightly else '‚Äî' }}
                            </div>
                            <div style="display: inline-block; background: #c62828; color: white; border-radius: 50%; width: 32px; height: 32px; line-height: 32px; font-weight: bold; font-size: 11px; cursor: help;" 
                                 title="Rake count in the best performing fortnight">
                                {{ item.best_fortnightly_count if item.best_fortnightly_count else 0 }}
                            </div>
                        </td>
                        
                        <!-- Best Weekly -->
                        <td style="padding: 10px 4px; text-align: center; background: rgba(232, 245, 233, 0.4); border-right: 1px solid #dee2e6;">
                            <div style="font-weight: 700; color: #2e7d32; font-size: 13px; margin-bottom: 4px;">
                                {{ item.best_weekly if item.best_weekly else '‚Äî' }}
                            </div>
                            <div style="display: inline-block; background: #2e7d32; color: white; border-radius: 50%; width: 32px; height: 32px; line-height: 32px; font-weight: bold; font-size: 11px; cursor: help;" 
                                 title="Rake count in the best performing week">
                                {{ item.best_weekly_count if item.best_weekly_count else 0 }}
                            </div>
                        </td>
                        
                        <!-- Outliers Link -->
                        <td style="padding: 10px 4px; text-align: center; border-left: 2px solid #dee2e6; background: rgba(251, 233, 231, 0.4);">
                            <a href="/source_outliers/{{ item.source }}?commodity={{ item.commodity }}&destination={{ item.destination }}" 
                               style="color: #d84315; text-decoration: none; font-weight: bold; padding: 4px 8px; background: white; border: 1px solid #d84315; border-radius: 4px; display: inline-block; transition: all 0.2s; font-size: 10px;"
                               onmouseover="this.style.background='#d84315'; this.style.color='white';"
                               onmouseout="this.style.background='white'; this.style.color='#d84315';">
                                View ‚ö†Ô∏è
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div style="margin-top: 15px; padding: 12px; background: #fff8e1; border-left: 4px solid #ffa000; border-radius: 4px; font-size: 12px;">
            <strong style="color: #f57f17;">üìå How to Read the Table:</strong>
            <ul style="margin: 8px 0 0 20px; color: #666; line-height: 1.6;">
                <li><strong>Transit Time:</strong> Displayed at the top of each cell in hours (e.g., 45.2 hrs)</li>
                <li><strong>Rake Count:</strong> Shown in a colored circular badge below the transit time</li>
                <li><strong>Best Monthly:</strong> Lowest average transit time from any single month in the last 12 months</li>
                <li><strong>Best Fortnightly:</strong> Lowest average transit time from any fortnight in the last 6 months</li>
                <li><strong>Best Weekly:</strong> Lowest average transit time from any week in the last 3 months</li>
                <li>Hover over the circular badges in "Best" columns for additional context</li>
                <li>These "best" values represent peak performance benchmarks that can be targeted for improvement</li>
            </ul>
        </div>
    </div>
    {% endfor %}
{% else %}
    <div class="card" style="text-align: center; padding: 60px 20px;">
        <div style="font-size: 64px; margin-bottom: 20px; opacity: 0.3;">üìä</div>
        <h3 style="color: #666; margin-bottom: 10px;">No Data Available</h3>
        <p style="color: #999;">Please adjust your filters or upload data to see the analysis.</p>
    </div>
{% endif %}

<!-- Legend -->
<div class="card" style="margin-top: 20px; background: #f8f9fa; border: 2px solid #dee2e6;">
    <h3 style="color: #1f3a5f; margin-bottom: 15px;">üìñ Understanding the Dashboard</h3>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px;">
        <div style="padding: 12px; background: white; border-radius: 6px; border-left: 4px solid #0277bd;">
            <strong style="color: #0277bd;">Recent Performance (4 Months/8 Weeks/4 Days)</strong>
            <p style="font-size: 13px; color: #666; margin: 5px 0 0 0;">Shows average transit times and rake counts for recent periods to track current operational performance.</p>
        </div>
        
        <div style="padding: 12px; background: white; border-radius: 6px; border-left: 4px solid #7b1fa2;">
            <strong style="color: #7b1fa2;">Best Performance Benchmarks</strong>
            <p style="font-size: 13px; color: #666; margin: 5px 0 0 0;">Represents the lowest transit times achieved in any month/fortnight/week during the lookback period‚Äîyour performance targets.</p>
        </div>
        
        <div style="padding: 12px; background: white; border-radius: 6px; border-left: 4px solid #d84315;">
            <strong style="color: #d84315;">Outlier Analysis</strong>
            <p style="font-size: 13px; color: #666; margin: 5px 0 0 0;">Click "View ‚ö†Ô∏è" to see rakes with abnormal transit times from the last 30 days, identified using statistical methods (IQR).</p>
        </div>
    </div>
    
    <div style="margin-top: 15px; padding: 12px; background: #e8eaf6; border-radius: 6px;">
        <strong style="color: #3f51b5;">üí° How to Use This Dashboard:</strong>
        <ol style="margin: 8px 0 0 20px; color: #666; font-size: 13px; line-height: 1.7;">
            <li>Use filters to focus on specific commodities or destination plants</li>
            <li>Compare recent performance (left columns) against best benchmarks (middle columns)</li>
            <li>Identify routes where current performance is significantly below best performance</li>
            <li>Click outlier links to investigate specific problematic rakes</li>
            <li>Hover over count values in "Best" columns to see sample sizes</li>
        </ol>
    </div>
</div>

<style>
    /* Sticky header enhancement */
    table thead th {
        position: sticky;
        top: 0;
        z-index: 10;
    }
    
    /* Smooth scrolling for table */
    .card > div {
        scroll-behavior: smooth;
    }
    
    /* Enhanced tooltip styling */
    [title] {
        position: relative;
    }
</style>

{% endblock %}
